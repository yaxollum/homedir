#!/bin/python3

import time
import json
import requests
from pathlib import Path

def getWeatherData(api_key):
    url=f"https://api.openweathermap.org/data/2.5/weather?id=6173577&appid={api_key}&units=metric"
    data=requests.get(url).text
    decoder=json.JSONDecoder()
    return decoder.decode(data)

if __name__=="__main__":
    last_update=0

    with open(Path.home()/".secrets/api/api.openweathermap.org") as key_file:
        API_KEY=key_file.readline().strip()

    COULD_NOT_CONNECT="Could not connect to api.openweathermap.org"
    REGULAR_UPDATE_INTERVAL=600 # 10 minutes
    ERROR_UPDATE_INTERVAL=2 # 2 seconds

    while True:
        unix_time=time.time();
        if(unix_time-last_update>REGULAR_UPDATE_INTERVAL or 
                (weather_data==COULD_NOT_CONNECT and 
                    unix_time-last_update>ERROR_UPDATE_INTERVAL)):
            try:
                weather_data=getWeatherData(API_KEY)
            except Exception:
                weather_data=COULD_NOT_CONNECT
            last_update=unix_time

        time_str=time.strftime('%a %Y-%m-%d %H:%M', time.localtime(unix_time))
        if not isinstance(weather_data,str):
            sunrise_str=time.strftime('%H:%M', time.localtime(weather_data["sys"]["sunrise"]))
            sunset_str=time.strftime('%H:%M', time.localtime(weather_data["sys"]["sunset"]))
            conditions=weather_data["weather"][0]["description"]
            temperature=weather_data["main"]["temp"]
            wind_speed=weather_data["wind"]["speed"]
            output="%s | %d Â°C | %.2g m/s | %s | %s | %s "%(
                conditions,
                temperature,
                wind_speed,
                sunrise_str,
                sunset_str,
                time_str)
        else:
            output="%s | %s "%(weather_data,time_str)

        print(output,flush=True)
        time.sleep(0.1)
